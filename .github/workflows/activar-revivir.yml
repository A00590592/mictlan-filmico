name: 🔔 Activar Revivir (flujo unificado optimizado)

on:
  workflow_dispatch:
  repository_dispatch:
    types: [revivir_trigger]

jobs:
  activar_revivir:
    runs-on: ubuntu-latest
    steps:
      - name: 🪶 Clonar repositorio
        uses: actions/checkout@v4

      - name: 🕯️ Enviar señal al altar (MQTT directo sin TLS)
        env:
          MQTT_HOST: ${{ secrets.ALTAR_HOST }}
          MQTT_USER: ${{ secrets.ALTAR_USER }}
          MQTT_PASS: ${{ secrets.ALTAR_PASS }}
        run: |
          python3 - <<'EOF'
          import socket, struct, time

          def pkt_connect(client_id, user, pwd):
              vh = b'\x00\x04MQTT\x04\x02\x00<\x00'
              pl = (
                  struct.pack('!H', len(client_id)) + client_id.encode() +
                  struct.pack('!H', len(user)) + user.encode() +
                  struct.pack('!H', len(pwd)) + pwd.encode()
              )
              rl = len(vh) + len(pl)
              return b'\x10' + bytes([rl]) + vh + pl

          def pkt_publish(topic, msg):
              pl = struct.pack('!H', len(topic)) + topic.encode() + msg.encode()
              rl = len(pl)
              return b'\x30' + bytes([rl]) + pl

          def pkt_disconnect():
              return b'\xe0\x00'

          host = "${MQTT_HOST}"
          port = 1883
          user = "${MQTT_USER}"
          pwd  = "${MQTT_PASS}"
          topic = "Mictlan"
          payload = "revivir"
          client_id = f"GitHubAction_{int(time.time())}"

          try:
              with socket.create_connection((host, port), timeout=5) as s:
                  s.sendall(pkt_connect(client_id, user, pwd))
                  s.sendall(pkt_publish(topic, payload))
                  s.sendall(pkt_disconnect())
              print("✅ Señal de revivir enviada al altar físico.")
          except Exception as e:
              print("❌ Error al enviar MQTT:", e)
          EOF

      - name: 📅 Registrar evento en el log
        run: |
          echo "🪶 Registrando evento en data/revivir_log.json..."
          mkdir -p data
          FILE=data/revivir_log.json
          DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          MSG="Revivir ejecutado desde workflow - $DATE"
          if [ ! -f "$FILE" ]; then
            echo "[]" > "$FILE"
          fi
          cat "$FILE" | jq --arg m "$MSG" '. + [{"mensaje": $m}]' > tmp.json
          mv tmp.json "$FILE"

      - name: 💾 Commit & push log actualizado
        env:
          ALTAR_TOKEN: ${{ secrets.ALTAR_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          git config --global user.name "Altar Mictlan"
          git config --global user.email "altar@mictlan.io"
          git remote set-url origin https://x-access-token:${ALTAR_TOKEN}@github.com/${REPO}.git
          git add data/revivir_log.json
          git commit -m "🕯️ Revivir registrado (flujo unificado optimizado)" || echo "Nada que commitear"
          git push origin main
          echo "🪶 Registro completado con éxito y altar encendido."
